name: Validate Bicep Templates

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - '**.json'
      - '**.py'
      - '.github/workflows/validate.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - '**.json'
      - '**.py'
      - '.github/workflows/validate.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-bicep:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true
        
      - name: Install Bicep CLI
        run: |
          az bicep install
          az bicep version
        
      - name: Lint main template
        run: |
          echo "Linting main.bicep..."
          az bicep lint --file main.bicep
          
      - name: Build main template
        run: |
          echo "Building main.bicep..."
          az bicep build --file main.bicep --outfile /tmp/main.json
          
      - name: Lint and build modules
        run: |
          echo "Validating Bicep modules..."
          for file in modules/*.bicep; do
            echo "Linting $file..."
            az bicep lint --file "$file"
            echo "Building $file..."
            az bicep build --file "$file" --outfile "/tmp/$(basename $file .bicep).json"
          done
          
      - name: Validate parameter files
        run: |
          echo "Validating parameter files..."
          for file in parameters*.json; do
            echo "Checking $file..."
            jq empty "$file" && echo "âœ“ $file is valid JSON" || exit 1
          done
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bicep-build-artifacts
          path: /tmp/*.json
          retention-days: 5
          
  validate-python:
    name: Validate Python Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint
          
      - name: Check Python syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile deploy_rest.py
          
      - name: Lint Python code
        run: |
          echo "Linting Python code..."
          pylint deploy_rest.py --disable=C0103,C0114,C0115,C0116 --max-line-length=120
        continue-on-error: true
        
  validate-deployment:
    name: Validate Deployment (What-If)
    runs-on: ubuntu-latest
    needs: [validate-bicep, validate-python]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true
        
      - name: What-If Deployment
        run: |
          if [ -n "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "Running what-if deployment..."
            az deployment group what-if \
              --resource-group ${{ secrets.AZURE_RG_NAME || 'rg-sentinel-ci' }} \
              --template-file main.bicep \
              --parameters parameters.json \
              --no-pretty-print
          else
            echo "Azure credentials not configured, skipping what-if deployment"
          fi
        continue-on-error: true
